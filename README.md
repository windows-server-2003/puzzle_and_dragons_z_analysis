
## 生成され得る全盤面の出力
`generate_all_board.cpp` は、 $4, 5, 6$ 色それぞれについて、生成され得る盤面全てをファイル `all_boards_k.txt` (`k` は $4, 5, 6$) としてカレントディレクトリに出力します。  
コンパイル時には `include` をインクルードディレクトリに追加してください。  
生成されたファイルは、長さ $30$ の数字列と改行で構成される行が $2^{16} = 65536$ 行あります。 $1$ つの行が $1$ つの盤面に対応し、長さ $30$ の数字列は、盤面の**上の行**から、同じ行の中では左から順に見た時のドロップ種類を表します。  
数字 $i$ は、ダンジョンの指定ドロップ種類を火, 水, 木, 光, 闇, 回復の順に並べた時の $i$ 番目番目の色を表します。  
例えば火, 水, 木, 回復のダンジョンでは `all_boards_4.txt` を見ればよく、ファイル内の $0, 1, 2, 3$ はそれぞれ火, 水, 木, 回復を意味します。  

## 実行コードの解析
必要なもの
 - [devkitPro](https://devkitpro.org/)に含まれるツールチェインdevkitARM
   `[devkitProのインストールパス]/devkitARM/bin` にPATHを通すか、以下で `arm-none-eabi-objdump` を使う際にこちらの絶対パスを指定してください。  
 - [ctrtool](https://github.com/3DSGuy/Project_CTR/releases)
 - パズドラZの.ciaファイル  
   CFW導入済みの実機でGodMod9等のツールを用いて吸い出せます。  

```
ctrtool --exefsdir=exefs --decompresscode [.ciaファイル名]
```
で`exefs/code.bin`に実行コードが出力されます。  
```
cd exefs
arm-none-eabi-objdump -b binary -m armv6 -D code.bin > asm.s
```
で `asm.s` に逆アセンブル結果が出力されます。  
この `code.bin` は実行時に `0x00100000` に配置されるので、実行時に命令書き換えとかするときはこれを足す必要があります。  
以下に私が見て分かったことを記します。  

 - 0x4235c : 乱数生成器から呼ばれている `svcGetSystemTick`
 - 0x7cc2c : 盤面の初期化をしてそうな関数  
   引数はr0の1つ。
   r0 + 0 (u8), r0 + 1(u8) : 盤面の縦/横のドロップ数。どっちがどっちかは忘れた。
   `mov r1, [r0, #12]`とすると、どうやらもろもろが`r1`の指す先に入ってる
     - r1 + 0x633b0 : 72 Byteのドロップを表す構造体の16x16配列  
	    Drop構造体
		 - +4 u16 : ドロップの種類
		 - +6 u16 : これもドロップの種類 ?
	 - r1 + 0x67bb0 : 上記のドロップを指すポインタが16x16で並んでいそう。
	 - r1 + 0x6b71c : u8 ダンジョンのドロップ種類数
	 - r1 + 0x6b71e : u8[] ダンジョンのドロップ種類リスト
	
	0x7cd7cで盤面全体のランダム初期化のために乱数生成器を呼んでいる。  
	0x7cea0あたりからコンボ除去が始まっている
	関数0xEB8ACは使われている文脈的に多分「(i, j)を含むコンボが存在するか」みたいな感じのものだと思う。中身は見てない
	
 - 0x5ac9c : `svcGetSystemTick` を使った乱数の初期化関数。
 - 0xec668 : $8$ 個の乱数生成器のうち特定の $1$ つだけの状態を変えるもの。`index=3`でしか呼ばれていないので盤面生成には関係ない。
 - 0xfaaf8 : ランダムな数を生成する。
 - 0x11e9b8 ~ メルセンヌツイスターっぽいものの初期化をしている。0x5ac9cの最後で呼び出されている。
 


